# Angrav Docker Compose - Separate browser and worker containers

services:
  # Browser container - heavy, rarely rebuilt
  # Contains: Windsurf IDE, Xvfb, VNC server, socat CDP proxy
  angrav-browser:
    build:
      context: ..
      dockerfile: docker/Dockerfile.browser
    image: angrav-browser:latest
    container_name: angrav-browser
    hostname: angrav-browser

    ports:
      # VNC for debugging (connect with any VNC client)
      - "5901:5900"
      # CDP proxy for external Playwright access
      - "9223:9223"

    volumes:
      # Workspace - your tasks and project files
      - ./workspace:/workspace

      # Persistent auth/settings (survives container restart)
      - angrav-config:/home/angrav/.config/Antigravity

    environment:
      - TZ=Europe/Prague

    # Resource limits for Electron app
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

    restart: unless-stopped

  # Worker container - lightweight, fast rebuilds
  # Contains: Node.js, Playwright automation code
  angrav-worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.worker
    image: angrav-worker:latest
    container_name: angrav-worker

    volumes:
      # Shared workspace for tasks/output
      - ./workspace:/workspace

    environment:
      # Connect to browser container via CDP proxy
      - BROWSER_CDP_ENDPOINT=http://angrav-browser:9223
      - NODE_ENV=production

    depends_on:
      - angrav-browser

    restart: unless-stopped

volumes:
  angrav-config:
    name: angrav-config

# Usage:
#
# Build both containers:
#   docker compose build
#
# Start:
#   docker compose up -d
#
# View logs:
#   docker compose logs -f
#   docker compose logs -f angrav-browser
#   docker compose logs -f angrav-worker
#
# First-time auth:
#   1. Connect VNC: vncviewer localhost:5901
#   2. Log in to Windsurf in the GUI
#   3. Auth persists in angrav-config volume
#
# Submit a task:
#   echo '{"prompt": "Create a Python hello world"}' > workspace/tasks/task-001.json
#
# Check output:
#   cat workspace/output/task-001-result.json
#
# Rebuild worker only (fast):
#   docker compose build angrav-worker
#   docker compose up -d angrav-worker
#
# Stop:
#   docker compose down
